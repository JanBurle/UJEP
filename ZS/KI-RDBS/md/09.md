# 09 – Kursory, výjimky

## Kursory

Dotazy vrací potencielně mnoho řádků:

```sql
select * from city;
```

Místo přenosu celého výsledku (tabulky) lze otevřít kursor ("portál", jakýsi stav dotazu) a záznamy načítat postupně pomocí FETCH (a také přeskakovat pomocí MOVE).

```sql
-- neefektivní kód, jen jako příklad
create or replace function count_cities(like_name text = '%')
  returns integer as $$
declare
  city_cursor cursor for select id, name from city where name like like_name;
  city_record record;
  cnt integer;
begin
  cnt = 0;
  open city_cursor;
  loop
    fetch next from city_cursor into city_record;
    exit when not found;
    -- city with enough weather records
    if 20 < (select count(*) from weather where city_id=city_record.id) then
      cnt = cnt + 1;
    end if;
    -- if 'bb' = city_record.id then
    --  exit;
    -- end if;
  end loop;

  close city_cursor;
  return cnt;
end; $$ language plpgsql;

select count_cities();
select count_cities('%');
select count_cities('Ci%Z');
```

## Chyby, výjimky a jejich obsluha

### Signalizace a obsluha chyb

- funkce vrací chybový kód (C, Unix: errno)
- funkce vrací hodnotu a chybový kód
- nastává výjimka

Otázky: Víme, jaké chyby mohou nastat? Lze chybovou situaci ignorovat?

### SQL: výjimky

(remove _check_temp_)

Ukázková funkce s kursorem:

```sql
select * from weather where city_id = 'bc';
update weather set temp_lo=temp_hi, temp_hi=temp_lo where city_id = 'bc';
```

```sql
-- průměrná teplota v městech s vybranými id
create or replace function avg_temp_lo(like_id text = '%')
  returns real as $$
declare
  weather_cursor cursor for select city_id, temp_lo, temp_hi from weather;
  weather_record record;
  cnt integer;
  sum real;
begin
  cnt = 0; sum = 0;

  open weather_cursor;
  loop
    fetch next from weather_cursor into weather_record;
    exit when not found;

    -- if not (weather_record.temp_lo <= weather_record.temp_hi) then
    --  raise exception 'Invalid temperature data: %', weather_record;
    -- end if;

    if weather_record.city_id like like_id then
      cnt = cnt + 1;
      sum = sum + weather_record.temp_lo;
    end if;
  end loop;

  close weather_cursor;
  return sum / cnt;
-- exception
--  when division_by_zero then
--    return null;
--  when others then
--    ...;
end; $$ language plpgsql;

select avg_temp_lo();
select avg_temp_lo('%');
select avg_temp_lo('%z');
select avg_temp_lo('%Z'); -- error
-- add exception handler
-- add raise exception
```
