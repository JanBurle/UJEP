# 11 ‚Äì ORM: Object-Relational Mapping

Datab√°ze:

1. Relaƒçn√≠ datab√°ze, RDB(M)S
2. Objektov√© datab√°ze, O(O)DB(M)S
3. Objektovƒõ-relaƒçn√≠ mapov√°n√≠, ORM

## 1. Relaƒçn√≠ datab√°ze, RDB(M)S

- Relational Database Management Systems
- orientovan√© na tabulky a relace

### Pre-SQL

Programovac√≠ jazyk s integrovanou datab√°z√≠.

- dBase III

```
USE WEATHER
SET FILTER TO CityId = "ul"
GO TOP
DO WHILE .NOT. EOF()
    ? Date, TempLo, TempHi
    SKIP
ENDDO
```

- Progress 4GL

```
FOR EACH Weather WHERE Weather.CityId = "ul":
    DISPLAY Weather.Date Weather.TempLo Weather.TempHi.
END.
```

### SQL

- 1974 ‚Äì IBM Research, SEQUEL
  - _manipulace mnoha z√°znam≈Ø najednou_
- 1980 ‚Äì SQL pou≈æit firmou Relational Software, dnes Oracle
- 1986 ‚Äì prvn√≠ standard SQL-86

### QBE ‚Äì Query By Example

Grafick√© rozhran√≠ pro tvorbu SQL dotaz≈Ø.

- ~1990 ‚Äì Paradox/DOS, Borland

<!-- #### SQL

```sql
select c.name as city, w.date as date, w.temp_lo as lo, w.temp_hi as hi
from city c join weather w on c.id = w.city_id order by c.name, w.date
where c.id = 'at' and w.date >= '2004-11-01';
``` -->

<!-- #### QBE -->

| **City** | id   | name |
| -------- | ---- | ---- |
| Name     |      | city |
| Show     |      | ‚úî    |
| Criteria | 'at' |      |
| Join     | id   |      |
| Sort     |      | ‚úî    |

| **Weather** | city_id | temp_lo | temp_hi | date            |
| ----------- | ------- | ------- | ------- | --------------- |
| Name        |         | lo      | hi      | date            |
| Show        |         | ‚úî       | ‚úî       | ‚úî               |
| Criteria    |         |         |         | >= '2004-11-01' |
| Join        | id      |         |         |                 |
| Sort        |         |         |         | ‚úî               |

## 2. Objektov√© datab√°ze, ODB(M)S

- Object(-Oriented) Database Management Systems
- _transparetn√≠_ persistence pro objekty v OO jazyc√≠ch: Perl, Ruby, Smalltalk, Python ...

- 1966 ‚Äì p≈ôedch≈Ødce: [MUMPS](https://en.wikipedia.org/wiki/MUMPS), vestavƒõn√° datab√°ze
- ~1990 ‚Äì prvn√≠ generace:
  - [ObjectStore](https://en.wikipedia.org/wiki/ObjectStore), C++
  - [Gemstone](https://en.wikipedia.org/wiki/GemStone/S), SmallTalk, Java
  - [ZODB](https://en.wikipedia.org/wiki/Zope_Object_Database), Python
- ~2000 ‚Äì druh√° generace

#### MUMPS

```
; MUMPS Code for Managing Patient Data

START ;
    ; Add patients to the global variable
    D ADDPATIENT("John Doe", 45, "Hypertension")
    D ADDPATIENT("Jane Smith", 38, "Diabetes")
    D ADDPATIENT("Alice Brown", 29, "Asthma")

    ; Display patient data
    D SHOWPATIENTS

    ; Update a patient's diagnosis
    D UPDATEPATIENT("John Doe", "Hypertension", "High Blood Pressure")

    ; Display updated patient data
    D SHOWPATIENTS

    Q

ADDPATIENT(NAME, AGE, DIAGNOSIS) ;
    ; Adds patient information to the global variable ^PATIENTS
    ; Global format: ^PATIENTS(PatientID, "Name") = Name
    ;               ^PATIENTS(PatientID, "Age") = Age
    ;               ^PATIENTS(PatientID, "Diagnosis") = Diagnosis
    NEW PATIENTID,GLOBAL
    SET PATIENTID=$O(^PATIENTS(""),-1)+1  ; Create a new unique patient ID
    SET ^PATIENTS(PATIENTID,"Name")=NAME
    SET ^PATIENTS(PATIENTID,"Age")=AGE
    SET ^PATIENTS(PATIENTID,"Diagnosis")=DIAGNOSIS
    QUIT

SHOWPATIENTS ;
    ; Display all patient information
    NEW PATIENTID
    SET PATIENTID=0
    FOR  SET PATIENTID=$O(^PATIENTS(PATIENTID)) QUIT:PATIENTID=""  DO
    . WRITE !,"Patient ID: ",PATIENTID
    . WRITE !,"Name: ",^PATIENTS(PATIENTID,"Name")
    . WRITE !,"Age: ",^PATIENTS(PATIENTID,"Age")
    . WRITE !,"Diagnosis: ",^PATIENTS(PATIENTID,"Diagnosis")
    . WRITE !!
    QUIT

UPDATEPATIENT(NAME, OLD_DIAGNOSIS, NEW_DIAGNOSIS) ;
    ; Updates the diagnosis of a specific patient
    NEW PATIENTID
    SET PATIENTID=0
    FOR  SET PATIENTID=$O(^PATIENTS(PATIENTID)) QUIT:PATIENTID=""  DO
    . IF ^PATIENTS(PATIENTID,"Name")=NAME, ^PATIENTS(PATIENTID,"Diagnosis")=OLD_DIAGNOSIS DO
    . . SET ^PATIENTS(PATIENTID,"Diagnosis")=NEW_DIAGNOSIS
    . . WRITE "Updated ", NAME, "'s diagnosis to: ", NEW_DIAGNOSIS, !
    QUIT
```

```yaml
Patient ID: 1
Name: John Doe
Age: 45
Diagnosis: Hypertension

Patient ID: 2
Name: Jane Smith
Age: 38
Diagnosis: Diabetes

Patient ID: 3
Name: Alice Brown
Age: 29
Diagnosis: Asthma

Updated John Doe's diagnosis to: High Blood Pressure

Patient ID: 1
Name: John Doe
Age: 45
Diagnosis: High Blood Pressure

Patient ID: 2
Name: Jane Smith
Age: 38
Diagnosis: Diabetes

Patient ID: 3
Name: Alice Brown
Age: 29
Diagnosis: Asthma
```

#### ObjectStore

```cpp
#include <os_....h>

class City : public os_persistent {
public:
    os_char *id;
    os_char *name;

    City(char const* id, char const* name) {
        this->id   = os_strdup(id);
        this->name = os_strdup(name);
    }

    ~City() {
        os_free(id);
        os_free(name);
    }

    void print() {
        ...
    }
};

void writeDb(os_database *db) {
    os_transaction::begin(os_transaction::update);

    auto city = new(db, "city") os_collection<City*>();
    city->insert(new(db) City("mo", "Most"));
    city->insert(new(db) City("bi", "B√≠lina"));

    os_transaction::commit();
}

void readDb(os_database *db) {
    os_transaction::begin(os_transaction::read_only);

    auto city = db->lookup<os_collection<City*>>("city");
    for (auto it = city->begin(); it != city->end(); ++it) {
        (*it)->print();
        ...
    }

    os_transaction::commit();
}

int main() {
    os_initialize();

    auto db = os_database::open("city.db", 0, 0644)
    write_data(db);
    read_data(db);

    db->close();
    os_finalize();

    return 0;
}
```

#### ZODB

```python
!pip install ZODB
```

Definice dat:

```python
from persistent import Persistent

class City(Persistent):
  def __init__(self, id, name):
    # no need to call: super().__init__()
    self.id = id
    self.name = name

  def __repr__(self):
    return f"City(id='{self.id}', name='{self.name}')"

class Weather(Persistent):
  def __init__(self, city_id, temp_lo, temp_hi, date):
    self.city_id = city_id
    self.temp_lo = temp_lo
    self.temp_hi = temp_hi
    self.date = date

  def __repr__(self):
    return f"Weather(city_id='{self.city_id}', temp_lo={self.temp_lo}, temp_hi={self.temp_hi}, date={self.date})"
```

Z√°pis:

```python
from ZODB import FileStorage, DB
import transaction
from mydb import *

storage = FileStorage.FileStorage('weather.fs')
db = DB(storage)
connection = db.open()
root = connection.root()

try:
  transaction.begin()

  for coll in ['city', 'weather']:
    if coll not in root: root[coll]  = {}

  collCity = root['city']
  collCity['mo'] = City('mo', 'Most')
  collCity['bi'] = City('bi', 'B√≠lina')

  collWeather = root['weather']
  collWeather[('mo', '2023-10-01')] = Weather('mo', 10, 20, '2023-10-01')
  collWeather[('bi', '2023-10-01')] = Weather('bi', 12, 22, '2023-10-01')

  transaction.commit()

finally:
  connection.close()
  db.close()
```

ƒåten√≠:

```python
from ZODB import FileStorage, DB
import transaction
from mydb import *

storage = FileStorage.FileStorage('weather.fs')
db = DB(storage)
connection = db.open()
root = connection.root()

try:
  transaction.begin()

  print(root)

  for city in root['city'].values():
    print(city)

  for weather in root['weather'].values():
    print(weather)

  transaction.commit()

finally:
  connection.close()
  db.close()
```

## 3. Objektovƒõ-relaƒçn√≠ mapov√°n√≠

- Konverze dat mezi objektov√Ωm a relaƒçn√≠m modelem.
- OO programovac√≠ jazyk ü†à ORM ü†ä RDBS
- To nejlep≈°√≠ z obou svƒõt≈Ø: flexibiln√≠ objektov√Ω model a v√Ωkonn√° relaƒçn√≠ datab√°ze.

ORM je abstrakce nad SQL, kter√° umo≈æ≈àuje pracovat s datab√°z√≠ pomoc√≠ objekt≈Ø.

### Proƒç ORM?:

- Relaƒçn√≠ datab√°ze zv√≠tƒõzily. Jsou v√Ωkonn√©, optimalizovan√©, ≈°iroce pou≈æ√≠van√©. Jazyky jsou OO: je zde _impedance mismatch_. ORM se to sna≈æ√≠ vy≈ôe≈°it.

### Kritika:

- Netƒõsn√°, dƒõrav√° (leaky) abstrakce.
- N√≠zk√Ω v√Ωkon, vinou nadbyteƒçn√Ωch dotaz≈Ø.
- Slo≈æitost. Nen√≠ jednoduch√© synchronizovat objekty v pamƒõti / tabulky v datab√°zi. Je to tƒõ≈æk√Ω, netrivi√°ln√≠ probl√©m. ORM nen√≠ lehk√© se nauƒçit.
- _Impedance mismatch_ ‚Äì objects (OO) / tuples (RDBS) ‚Äì nelze snadno p≈ôekonat.
- Problematick√© nen√≠ ani tolik mapov√°n√≠ objekt≈Ø a relac√≠, ale mapov√°n√≠ dat v pamƒõti a dat v datab√°zi. Zmƒõna na jedn√© stranƒõ - jak a kdy ji p≈ôen√©st na druhou stranu? (multi-processing)
- Velk√° oƒçek√°v√°n√≠, ƒç√°steƒçn√° disiluze.
- ORM a aplikace pou≈æ√≠vaj√≠c√≠ ORM maj√≠ tendenci se st√°t bloatwarem.

### Kac√≠≈ôsk√©/rebelsk√© n√°zory:

- Je l√©pe si "ubalit svoje vlastn√≠" ORM.
- Alespo≈à pro zmƒõny v datab√°zi je lep≈°√≠ pou≈æ√≠t SQL: tedy ORM pro ƒçten√≠, SQL pro z√°pis.

### Vzestup a p√°d ORM:

[Gartner Hype Cycle](https://en.wikipedia.org/wiki/Gartner_hype_cycle)

1996: [Object-Relational DBMSs, The next great wave](https://www.amazon.com/Object-Relational-DBMSs-Kaufmann-Management-Systems/dp/1558603972)

2006: [Object-Relational Mapping is the Vietnam of Computer Science](https://blog.codinghorror.com/object-relational-mapping-is-the-vietnam-of-computer-science/)

### Pou≈æ√≠t ORM nebo ne?

- Zvolit podle aplikace:
  - pokud jsou data v√≠ce-m√©nƒõ relaƒçn√≠, pou≈æijte RDBS
  - pokud jsou data objektov√°/grafov√°
    - pokud jsou jednoduch√°, pou≈æijte RDBS a vlastn√≠ mapov√°n√≠
    - pokud jsou slo≈æit√°, pou≈æijte ODBS/ORM
  - pokud je pot≈ôeba podporovat v√≠cero RDMBS, lze pou≈æ√≠t (ƒç√°sti) ORM jako SQL abstrakci

To jest, zva≈æte mo≈ænosti:

- vzd√°t se objekt≈Ø
- vzd√°t se tabulek
- mapovat ruƒçnƒõ
- akceptovat (a ≈æ√≠t v hranic√≠ch) omezen√≠ ORM

### ORM software:

[Seznam](https://en.wikipedia.org/wiki/List_of_object%E2%80%93relational_mapping_software)

## SQLAlchemy

Dvƒõ ƒç√°sti: Core a ORM

#### Core

Abstrakce nad r≈Øzn√Ωmi RDBS, m√≠sto psan√≠ SQL: v√Ωrazy v Pythonu

#### ORM (Object Relational Mapper)

Pr√°ce s t≈ô√≠dami a objekty v Pythonu: interakce s tabulkami v datab√°zi.

- podporuje ≈ôadu datab√°z√≠ a adapt√©r≈Ø
- ka≈æd√° t≈ô√≠da je reprezentovan√° tabulou
- netƒõsn√° abstrakce: `text()`

```python
!pip install SQLAlchemy
```

Definice dat, Core:

```python
from sqlalchemy import Column, ForeignKey, CheckConstraint
from sqlalchemy import String, Integer, Date
from sqlalchemy.orm import declarative_base, relationship

from datetime import date

# The base of all mapped classes
Base = declarative_base()

class City(Base):
  __tablename__ = 'city2'
  id      = Column(String(2), primary_key=True)
  name    = Column(String(80), nullable=False)
  weather = relationship("Weather", back_populates="city")

class Weather(Base):
  __tablename__ = 'weather2'
  city_id = Column(String(2), ForeignKey('city2.id'), primary_key=True) # leaky
  temp_lo = Column(Integer, nullable=False)
  temp_hi = Column(Integer, nullable=False)
  date    = Column(Date, primary_key=True, default=date.today)
  city    = relationship("City", back_populates="weather")
  __table_args__ = (
    CheckConstraint('temp_lo <= temp_hi', name='check_temp'),
  )

DB_URL = 'sqlite:///example.db'
# DB_URL = 'postgresql+psycopg://app-user:app-pwd@localhost:5432/app'
```

Z√°pis:

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from mydb import *

engine = create_engine(DB_URL, echo=True)

# create tables
Base.metadata.create_all(engine)

# database connection
Session = sessionmaker(bind=engine)

with Session() as session:
  import random
  from datetime import date, timedelta

  for id1 in range(ord('a'), ord('d') + 1):
    for id2 in range(ord('a'), ord('d') + 1):
      city_id = chr(id1) + chr(id2)
      city_name = 'City ' + city_id.upper()
      city = City(id=city_id, name=city_name)
      session.add(city) # !!!

      for days in range(7):
        temp_lo = random.randint(0, 30)
        temp_hi = temp_lo + random.randint(0, 10)
        weather_date = date.today() - timedelta(days=days)
        weather = Weather(city_id=city_id, temp_lo=temp_lo, temp_hi=temp_hi, date=weather_date)
        session.add(weather) # !!!

  session.commit() # !!!
```

ƒåten√≠:

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from mydb import *

engine = create_engine(DB_URL, echo=True)

# database connection
Session = sessionmaker(bind=engine)

with Session() as session:
  for city in session.query(City.id,City.name).all():
    print(city)
    print(f"City: {city.name}")

  for city in session.query(City).filter_by(id='at').all():
    print(city)
    print(city.__dict__)
    print(f"City: {city.name}")
    for weather in city.weather: # !!!
      print(weather)
      print(f"  Weather: {weather.date}, Low: {weather.temp_lo}, High: {weather.temp_hi}")

  for city in session.query(City).all():
    print(f"City: {city.name}")
    for weather in city.weather: # !!!
      print(f"  Weather: {weather.date}, Low: {weather.temp_lo}, High: {weather.temp_hi}")
```
