# 10 – Programování klientů: Python / PHP

## Psycopg ("psycho" / postgres)

https://www.psycopg.org/docs/

PostgreSQL adapter for Python.

- metody:
  - connect()
  - execute()
- konvertuje data mezi pg/python
- parametrizace dotazů (prevence sql injection)
- podporuje kursory

## PDO (PHP Data Objects)

https://www.php.net/manual/en/book.pdo.php

PHP interface pro přístup k databázím.

## Databázové role a uživatelé

Dříve (a jiné DBS): `create group`, `create user`. Dnes v PG je `create user` totéž jako `create role`.

Superuser je definovaný v `docker-compose.yml`:

```
services:
  postgres:
    environment:
      POSTGRES_USER: ...
```

Vytvoření obyčejného uživatele, připojeni jako superuser: \
`psql -U app-user app`

```sql
select current_user;
create user joe password 'joepwd';
```

Otevřeme databázové spojení jako `joe`:\
`psql -U joe app` \
a pak:

```sql
select current_user;
select * from city;  -- doh!
delete from weather; -- that's safety
update weather set temp_hi=30 where date='2024-11-09';
```

Jako superuser přiděkujeme nebo odebíráme rolím/uživatelům oprávnění k operacím a tabulkám, atd.:

```sql
grant select on city to joe;
grant select,update on weather to joe;
revoke select on city from joe;
revoke all on city, weather from joe;
```

## Ukázkový [projekt](../projekt-klienti)

- [docker compose](../projekt-klienti/docker-compose.yml)
  - web server, Python
  - postgres, databáze: app, skript pro inicializaci databáze

### Code walkthrough

- [init-db](../projekt-klienti/init)

  - uživatel joe
  - tabulky
  - testovací data
  - triggery
  - funkce a procedury pro Pepu

* Shell do kontejneru [postgres](../projekt-klienti/bashpg.sh)

  - `psql -U app-user app`
  - příkazy:
    - help
    - \\?, \\c, \\dt
    - `select * from audit_log;`
    - \\q
  - ^D

* Shell do kontejneru [webserver](../projekt-klienti/bashws.sh)

  - mc
  - python3 <file.py>
  - ^D

- [Python](../projekt-klienti/src)

  - `1 - test.py`: test connect() + execute()
  - `2 - show-log.py`: select \* from audit_log, sql injection
  - `3 - weather-select.py`: select \* from weather, select <function()>
  - `4 - weather-insert.py`: insert into weather, transaction
  <!-- - `5 - pyqt.py`: Qt application -->

- [PHP](../projekt-klienti/www)
  - `index.php`: web page
