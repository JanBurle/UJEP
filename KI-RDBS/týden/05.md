# 05 – (Full)textové vyhledávání

Vyhledávání v textových dokumentech.

[PostgreSQL Ch.12](https://www.postgresql.org/docs/current/textsearch.html)

## Textový dokument

Text v _přirozeném_, lidském jazyce (_přirozené_ x _umělé/formální_ jazyky).

Text je čten z:

- textových polí (sloupců) tabulky
- spojení a agregací textových polí
- vnějších textových souborů – v databázi jsou jen indexy a odkazy

### Vyhledávání

Položit dotaz (query), vyhledat odpovídající dokumenty nebo fragmenty dokumentu.

Typicky v textu vyhledáváme slova, fráze/sousloví, množiny slov, a to

- bez ohledu na gramatický tvar (ohýbání slov)
- s překlepy (přibližné vyhledávání, fuzzy search)
- s přihlédnutím na blízkost (proximitu) slov
- s ohledem na synonyma
- bez ohledu na nevýznamná slova (předložky, spojky, pomocná slovesa, částice)

Výsledek lze řadit podle koeficientu shody (ranking).

### Předzpracování

Dokument musí být předzpracován (preprocessed) a indexován (pomocí externích nástrojů, jako je např. [ispell](https://en.wikipedia.org/wiki/Ispell)). Provede se:

- tokenizace (rozdělení na tokeny a jejich klasifikace do tříd - čísla, slova, složená slova, emailové adresy, ...)
  - standard parser, custom parser
- konverze na lexémy (transformace slov na základní, společný tvar, slova užitečná pro hledání) pomocí slovníků
  - malá písmena, odstranění přípon, ...
- odstranění stop words (velmi často používaná slova, irrelevantní pro hledání)
- výměna synonym (podle slovníku)
- uložení jako pole normalitovaných lexémů a jejich pozic v textu (pro proximity search)

## PostgreSQL

### tsvector

Dokument je potřeba konvertovat na typ `tsvector`:

```sql
select 'a fat cat sat on a mat and ate a fat rat';              -- text
select 'a fat cat sat on a mat and ate a fat rat'::tsvector;    -- tsvector, přetypováno (cast)
select to_tsvector('a fat cat sat on a mat and ate a fat rat'); -- tsvector, konvertováno
```

### tsquery

Dotaz je potřeba konvertovat na typ `tsquery`:

```sql
select 'cat & rat';               -- text
select 'cat & rat'::tsquery;      -- přetypováno
select to_tsquery('cat & rat');   -- konvertováno
```

### Dotazy: _match_ operátor @@

Shoduje se text (dokument) s dotazem? Vrací boolean:

```sql
select 'a fat cat sat on a mat and ate a fat rat' @@ 'cat & rat'; -- implicitní cast
select 'a fat cat sat on a mat and ate a fat rat'::tsvector @@ 'cat & rat'::tsquery;
select 'cat & rat'::tsquery @@ 'a fat cat sat on a mat and ate a fat rat'::tsvector;

select to_tsvector('fat cats ate fat rats') @@ to_tsquery('fat & rat');
select to_tsquery('fat & rat') @@ to_tsvector('fat cats ate fat rats');
```

Dotazy lze logicky kombinovat:

```sql
select 'fat | rat'::tsquery && 'cat'::tsquery; -- and
select 'fat | rat'::tsquery || 'cat'::tsquery; -- or
select !!'fat | rat'::tsquery;                 -- not

select 'a fat cat sat on a mat and ate a fat rat' @@ ('fat | rat'::tsquery && 'cat'::tsquery);
select 'a fat cat sat on a mat and ate a fat rat' @@ ('fat | rat'::tsquery && !! 'cat'::tsquery);
```

Dotazovat se lze na fráze (posloupnost slov):

```sql
select 'fat'::tsquery <-> 'rat'::tsquery;
select to_tsquery('fat') <-> to_tsquery('rat');

select 'a fat cat sat on a mat and ate a fat rat' @@ ('fat'::tsquery <-> 'rat'::tsquery);
select 'a fat cat sat on a mat and ate a fat rat' @@ ('fat'::tsquery <-> 'cat'::tsquery);
select 'a fat cat sat on a mat and ate a fat rat' @@ ('fat'::tsquery <-> 'sat'::tsquery);
```

Nalezenou shodu lze zvýraznit:

```sql
select ts_headline('a fat cat sat on a mat and ate a fat rat', 'fat & sat');
select ts_headline('english'::regconfig, 'a fat cat sat on a mat and ate a fat rat', 'fat & sat'::tsquery);
```

I obyčejný text lze konvertovat na dotaz:

```sql
select plainto_tsquery('english', 'The Fat Rats...?');
select plainto_tsquery('The Fat Rats...?');

select phraseto_tsquery('english', 'The Fat Rats...?');
select phraseto_tsquery('The Fat Rats...?');

select plainto_tsquery('basque', 'The Fat Rats...?'); -- Hmm...
select plainto_tsquery('czech', 'The Fat Rats...?');  -- Doh! Cože?
```

## PostgreSQL – podpora jazyků

```sql
select cfgname from pg_ts_config;
```

### Instalace podpory pro češtinu

- https://github.com/char0n/postgresql-czech-fulltext
- https://postgres.cz/wiki/Instalace_PostgreSQL#Instalace_Fulltextu

* [`cp-czech-dict.sh`](../projekt-fulltext/cp-czech-dict.sh): nahrát slovník
  - [`czech.dict`](../projekt-fulltext/dict/czech.dict): 300 000 řádek (Burle)
  - [`czech.affix`](../projekt-fulltext/dict/czech.affix): koncovky
  - [`czech.stop`](../projekt-fulltext/dict/czech.stop): stop words
* [`bash.sz`](../projekt-fulltext/bash.sh): otevřít shell (terminál) v kontejneru, pro kontrolu
  - `ls /usr/share/postgresql/18/tsearch_data`

```sql
create text search dictionary czech_spell(template=ispell, dictfile=czech, afffile=czech, stopwords=czech);
create text search configuration czech (copy=english);
alter text search configuration czech alter mapping for word, asciiword with czech_spell, simple;

select cfgname FROM pg_ts_config;

-- test
select * from ts_debug('czech','Příliš žluťoučký kůň se napil čiré vody.');
```

## Příklad textového dokumentu: R.U.R.

https://www.gutenberg.org/cache/epub/13083

### Textový soubor, import

- stáhnout https://www.gutenberg.org/cache/epub/13083/pg13083.txt
- ručně odstranit nepotřebný začátek a konec: [`RUR.txt`](../projekt-fulltext/texts/RUR.txt)
- zkonvertovat na CSV, např. [`convert.py`](../projekt-fulltext/convert.py): [`RUR.csv`](../projekt-fulltext/texts/RUR.csv)
- [`cp-texts.sh`](../projekt-fulltext/cp-texts.sh): nahrát texty

```sql
create table RUR (
  id serial primary key,
  para text
);

copy RUR from '/home/RUR.csv' with csv;

select count(*) from RUR;
select * from RUR limit 20;
```

### Dotazy

```sql
select to_tsvector('czech','roboti');
select to_tsquery('czech','roboti');
select to_tsvector('czech','bezbožné kejkle');
select to_tsquery('czech','bezbožné <-> kejkle');

select to_tsvector('czech',para), para from RUR;

select * from RUR where to_tsvector('czech',para) @@ to_tsquery('czech','robot');
select * from RUR where to_tsvector('czech',para) @@ to_tsquery('czech','robot & žárovka');
select * from RUR where to_tsvector('czech',para) @@ to_tsquery('czech','robot | žárovka');

select * from RUR where to_tsvector('czech',para) @@ to_tsquery('czech','bezbožný');
select * from RUR where to_tsvector('czech',para) @@ to_tsquery('czech','kejkle');
select * from RUR where to_tsvector('czech',para) @@ to_tsquery('czech','bezbožné <-> kejkle');
```

### Indexace

Pro urychlení fulltextových dokumentů je vhodné použít specializované indexy.

```sql
-- bez indexu
explain analyze select * from RUR where to_tsvector('czech',para) @@ to_tsquery('czech','robot & žárovka');

--- explain analyze
select
  ts_headline('czech', para, qry, 'StartSel=[, StopSel=]'),
  ts_rank_cd(to_tsvector('czech',para), qry) as rank
from RUR, to_tsquery('czech','roboti | lidé') as qry
where to_tsvector('czech',para) @@ qry
order by rank desc limit 6;

-- index
create index idx_rur on RUR using gin(to_tsvector('czech', para));
-- znovu: explain alalyze select ...
drop index idx_rur;
```

### Pomocná data

Při častém hledání je vhodné vytvořit pomocný sloupec s předpřipraveným fulltextovým vektorem:

```sql
alter table RUR add column tsv tsvector;
update RUR set tsv = to_tsvector('czech',para);

select * from RUR;

-- explain analyze
select
  ts_headline('czech', para, qry, 'StartSel=[, StopSel=]'),
  ts_rank_cd(tsv, qry) as rank
from RUR, to_tsquery('czech','roboti | lidé') as qry
where tsv @@ qry
order by rank desc limit 6;

alter table RUR drop column tsv;
```

Bez implicitního `cross join`, ale s opakováním:

```sql
select
  ts_headline('czech', para, to_tsquery('czech','roboti | lidé'), 'StartSel=[, StopSel=]') AS snippet,
  ts_rank_cd(tsv, to_tsquery('czech','roboti | lidé')) as rank
from rur
where tsv @@ to_tsquery('czech','roboti | lidé')
order by rank desc
limit 6;
```

Bez opakování a bez implicitního `cross join`:

```sql
create or replace function search_rur(terms text)
returns table(snippet text, rank float4)
language plpgsql as $$
declare
  qry tsquery := to_tsquery('czech', terms);
begin
  return query select
    ts_headline('czech', rur.para, qry, 'StartSel=[, StopSel=]'),
    ts_rank_cd(rur.tsv, qry)
  from rur
  where rur.tsv @@ qry;
end;
$$;

select * from search_rur('roboti | lidé') order by 2 desc limit 6;
```
